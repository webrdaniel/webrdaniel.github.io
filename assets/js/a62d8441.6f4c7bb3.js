"use strict";(self.webpackChunk=self.webpackChunk||[]).push([["97127"],{29946:function(e,t,n){n.r(t),n.d(t,{assets:function(){return s},contentTitle:function(){return l},default:function(){return d},frontMatter:function(){return r},metadata:function(){return i},toc:function(){return c}});var i=n(48064),a=n(85893),o=n(50065);let r={slug:"infinite-scroll-using-python",title:"How to scrape infinite scrolling webpages with Python",description:"Learn how to scrape infinite scrolling pages with Python and scrape Nike shoes using Crawlee for Python.",image:"./img/infinite-scroll.webp",authors:["SauravJ"]},l="How to scrape infinite scrolling webpages with Python",s={image:n(44953).Z,authorsImageUrls:[void 0]},c=[{value:"Prerequisites and bootstrapping the project",id:"prerequisites-and-bootstrapping-the-project",level:2},{value:"How to scrape infinite scrolling webpages",id:"how-to-scrape-infinite-scrolling-webpages",level:2},{value:"Handling accept cookie dialog",id:"handling-accept-cookie-dialog",level:3},{value:"Adding request of all shoes links",id:"adding-request-of-all-shoes-links",level:3},{value:"Extract data from product details",id:"extract-data-from-product-details",level:3},{value:"Accept Cookies context manager",id:"accept-cookies-context-manager",level:3},{value:"Handling infinite scroll on the listing page",id:"handling-infinite-scroll-on-the-listing-page",level:3},{value:"Exporting data to CSV format",id:"exporting-data-to-csv-format",level:2},{value:"Working crawler and its code",id:"working-crawler-and-its-code",level:2}];function h(e){let t={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,o.a)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.p,{children:"Hello, Crawlee Devs, and welcome back to another tutorial on the Crawlee Blog. This tutorial will teach you how to scrape infinite-scrolling websites using Crawlee for Python."}),"\n",(0,a.jsx)(t.p,{children:"For context, infinite-scrolling pages are a modern alternative to classic pagination. When users scroll to the bottom of the webpage instead of choosing the next page, the page automatically loads more data, and users can scroll more."}),"\n",(0,a.jsxs)(t.p,{children:["As a big sneakerhead, I'll take the Nike shoes infinite-scrolling ",(0,a.jsx)(t.a,{href:"https://www.nike.com/",children:"website"})," as an example, and we'll scrape thousands of sneakers from it."]}),"\n",(0,a.jsx)(t.p,{children:(0,a.jsx)(t.img,{alt:"How to scrape infinite scrolling pages with Python",src:n(67506).Z+"",width:"1152",height:"649"})}),"\n",(0,a.jsx)(t.p,{children:"Crawlee for Python has some amazing initial features, such as a unified interface for HTTP and headless browser crawling, automatic retries, and much more."}),"\n",(0,a.jsx)(t.h2,{id:"prerequisites-and-bootstrapping-the-project",children:"Prerequisites and bootstrapping the project"}),"\n",(0,a.jsx)(t.p,{children:"Let's start the tutorial by installing Crawlee for Python with this command:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"pipx run crawlee create nike-crawler\n"})}),"\n",(0,a.jsx)(t.admonition,{type:"note",children:(0,a.jsxs)(t.p,{children:["Before going ahead if you like reading this blog, we would be really happy if you gave ",(0,a.jsx)(t.a,{href:"https://github.com/apify/crawlee-python/",children:"Crawlee for Python a star on GitHub!"})]})}),"\n",(0,a.jsxs)(t.p,{children:["We will scrape using headless browsers. Select ",(0,a.jsx)(t.code,{children:"PlaywrightCrawler"})," in the terminal when Crawlee for Python asks for it."]}),"\n",(0,a.jsx)(t.p,{children:"After installation, Crawlee for Python will create boilerplate code for you. Redirect into the project folder and then run this command for all the dependencies installation:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"poetry install\n"})}),"\n",(0,a.jsx)(t.h2,{id:"how-to-scrape-infinite-scrolling-webpages",children:"How to scrape infinite scrolling webpages"}),"\n",(0,a.jsxs)(t.ol,{children:["\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:"Handling accept cookie dialog"}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:"Adding request of all shoes links"}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:"Extract data from product details"}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:"Accept Cookies context manager"}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:"Handling infinite scroll on the listing page"}),"\n"]}),"\n",(0,a.jsxs)(t.li,{children:["\n",(0,a.jsx)(t.p,{children:"Exporting data to CSV format"}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(t.h3,{id:"handling-accept-cookie-dialog",children:"Handling accept cookie dialog"}),"\n",(0,a.jsx)(t.p,{children:"After all the necessary installations, we'll start looking into the files and configuring them accordingly."}),"\n",(0,a.jsxs)(t.p,{children:["When you look into the folder, you'll see many files, but for now, let's focus on ",(0,a.jsx)(t.code,{children:"main.py"})," and ",(0,a.jsx)(t.code,{children:"routes.py"}),"."]}),"\n",(0,a.jsxs)(t.p,{children:["In ",(0,a.jsx)(t.code,{children:"main.py"}),", let's change the target location to the Nike website. Then, just to see how scraping will happen, we'll add ",(0,a.jsx)(t.code,{children:"headless = False"})," to the ",(0,a.jsx)(t.code,{children:"PlaywrightCrawler"})," parameters. Let's also increase the maximum requests per crawl option to 100 to see the power of parallel scraping in Crawlee for Python."]}),"\n",(0,a.jsx)(t.p,{children:"The final code will look like this:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:'from crawlee.playwright_crawler import PlaywrightCrawler\n\nfrom .routes import router\n\n\nasync def main() -> None:\n    """The crawler entry point."""\n    crawler = PlaywrightCrawler(\n        headless=False,\n        request_handler=router,\n        max_requests_per_crawl=100,\n    )\n\n    await crawler.run(\n        [\n            \'https://nike.com/,\n        ]\n    )\n'})}),"\n",(0,a.jsxs)(t.p,{children:["Now coming to ",(0,a.jsx)(t.code,{children:"routes.py"}),", let's remove:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"await context.enqueue_links()\n"})}),"\n",(0,a.jsx)(t.p,{children:"As we don't want to scrape the whole website."}),"\n",(0,a.jsx)(t.p,{children:"Now, if you run the crawler using the command:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"poetry run python -m nike-crawler\n"})}),"\n",(0,a.jsx)(t.p,{children:"As the cookie dialog is blocking us from crawling more than one page's worth of shoes, let's get it out of our way."}),"\n",(0,a.jsxs)(t.p,{children:["We can handle the cookie dialog by going to Chrome dev tools and looking at the ",(0,a.jsx)(t.code,{children:"test_id"}),' of the "accept cookies" button, which is ',(0,a.jsx)(t.code,{children:"dialog-accept-button"}),"."]}),"\n",(0,a.jsxs)(t.p,{children:["Now, let's remove the ",(0,a.jsx)(t.code,{children:"context.push_data"})," call that was left there from the project template and add the code to accept the dialog in routes.py. The updated code will look like this:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:'from crawlee.router import Router\nfrom crawlee.playwright_crawler import PlaywrightCrawlingContext\n\nrouter = Router[PlaywrightCrawlingContext]()\n\n@router.default_handler\nasync def default_handler(context: PlaywrightCrawlingContext) -> None:\n    """Default request handler."""\n\n    # Wait for the popup to be visible to ensure it has loaded on the page.\n    await context.page.get_by_test_id(\'dialog-accept-button\').click()\n'})}),"\n",(0,a.jsx)(t.h3,{id:"adding-request-of-all-shoes-links",children:"Adding request of all shoes links"}),"\n",(0,a.jsxs)(t.p,{children:["Now, if you hover over the top bar and see all the sections, i.e., man, woman, and kids, you'll notice the \u201CAll shoes\u201D section. As we want to scrape all the sneakers, this section interests us. Let's use ",(0,a.jsx)(t.code,{children:"get_by_test_id"})," with the filter of ",(0,a.jsx)(t.code,{children:"has_text='All shoes'"})," and add all the links with the text \u201CAll shoes\u201D to the request handler. Let's add this code to the existing ",(0,a.jsx)(t.code,{children:"routes.py"})," file:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"    shoe_listing_links = (\n        await context.page.get_by_test_id('link').filter(has_text='All shoes').all()\n    )\n    await context.add_requests(\n        [\n            Request.from_url(url, label='listing')\n            for link in shoe_listing_links\n            if (url := await link.get_attribute('href'))\n        ]\n    )\n\n@router.handler('listing')\nasync def listing_handler(context: PlaywrightCrawlingContext) -> None:\n    \"\"\"Handler for shoe listings.\"\"\"\n"})}),"\n",(0,a.jsx)(t.h3,{id:"extract-data-from-product-details",children:"Extract data from product details"}),"\n",(0,a.jsx)(t.p,{children:"Now that we have all the links to the pages with the title \u201CAll Shoes,\u201D the next step is to scrape all the products on each page and the information provided on them."}),"\n",(0,a.jsxs)(t.p,{children:["We'll extract each shoe's URL, title, price, and description. Again, let's go to dev tools and extract each parameter's relevant ",(0,a.jsx)(t.code,{children:"test_id"}),". After scraping each of the parameters, we'll use the ",(0,a.jsx)(t.code,{children:"context.push_data"})," function to add it to the local storage. Now let's add the following code to the ",(0,a.jsx)(t.code,{children:"listing_handler"})," and update it in the ",(0,a.jsx)(t.code,{children:"routes.py"})," file:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"\n@router.handler('listing')\nasync def listing_handler(context: PlaywrightCrawlingContext) -> None:\n    \"\"\"Handler for shoe listings.\"\"\"\n\n    await context.enqueue_links(selector='a.product-card__link-overlay', label='detail')\n\n\n@router.handler('detail')\nasync def detail_handler(context: PlaywrightCrawlingContext) -> None:\n    \"\"\"Handler for shoe details.\"\"\"\n\n    title = await context.page.get_by_test_id(\n        'product_title',\n    ).text_content()\n\n    price = await context.page.get_by_test_id(\n        'currentPrice-container',\n    ).first.text_content()\n\n    description = await context.page.get_by_test_id(\n        'product-description',\n    ).text_content()\n\n    await context.push_data(\n        {\n            'url': context.request.loaded_url,\n            'title': title,\n            'price': price,\n            'description': description,\n        }\n    )\n"})}),"\n",(0,a.jsx)(t.h3,{id:"accept-cookies-context-manager",children:"Accept Cookies context manager"}),"\n",(0,a.jsx)(t.p,{children:"Since we're dealing with multiple browser pages with multiple links and we want to do infinite scrolling, we may encounter an accept cookie dialog on each page. This will prevent loading more shoes via infinite scroll."}),"\n",(0,a.jsx)(t.p,{children:"We'll need to check for cookies on every page, as each one may be opened with a fresh session (no stored cookies) and we'll get the accept cookie dialog even though we already accepted it in another browser window. However, if we don't get the dialog, we want the request handler to work as usual."}),"\n",(0,a.jsx)(t.p,{children:"To solve this problem, we'll try to deal with the dialog in a parallel task that will run in the background. A context manager is a nice abstraction that will allow us to reuse this logic in all the router handlers. So, let's build a context manager:"}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"from playwright.async_api import TimeoutError as PlaywrightTimeoutError\n\n@asynccontextmanager\nasync def accept_cookies(page: Page):\n    task = asyncio.create_task(page.get_by_test_id('dialog-accept-button').click())\n    try:\n        yield\n    finally:\n        if not task.done():\n            task.cancel()\n\n        with suppress(asyncio.CancelledError, PlaywrightTimeoutError):\n            await task\n"})}),"\n",(0,a.jsxs)(t.p,{children:["This context manager will make sure we're accepting the cookie dialog if it exists before scrolling and scraping the page. Let's implement it in the ",(0,a.jsx)(t.code,{children:"routes.py"})," file, and the updated code is ",(0,a.jsx)(t.a,{href:"https://github.com/janbuchar/crawlee-python-demo/blob/6ca6f7f1d1bbbf789a3b86f14bec492cf756251e/crawlee-python-webinar/routes.py",children:"here"})]}),"\n",(0,a.jsx)(t.h3,{id:"handling-infinite-scroll-on-the-listing-page",children:"Handling infinite scroll on the listing page"}),"\n",(0,a.jsx)(t.p,{children:"Now for the last and most interesting part of the tutorial! How to handle the infinite scroll of each shoe listing page and make sure our crawler is scrolling and scraping the data constantly."}),"\n",(0,a.jsx)(t.p,{children:"This tutorial is taken from the webinar held on August 5th where Jan Buchar, Senior Python Engineer at Apify, gave a live demo about this use case. Watch the tutorial here:"}),"\n",(0,a.jsx)("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/ip8Ii0eLfRY?si=7ZllUhMhuC7VC23B&start=667",title:"YouTube video player",frameborder:"0",allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",referrerpolicy:"strict-origin-when-cross-origin",allowfullscreen:!0}),"\n",(0,a.jsxs)(t.p,{children:["To handle infinite scrolling in Crawlee for Python, we just need to make sure the page is loaded, which is done by waiting for the ",(0,a.jsx)(t.code,{children:"network_idle"})," load state, and then use the ",(0,a.jsx)(t.code,{children:"infinite_scroll"})," helper function which will keep scrolling to the bottom of the page as long as that makes additional items appear."]}),"\n",(0,a.jsxs)(t.p,{children:["Let's add two lines of code to the ",(0,a.jsx)(t.code,{children:"listing"})," handler:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"@router.handler('listing')\nasync def listing_handler(context: PlaywrightCrawlingContext) -> None:\n    \"\"\"Handler for shoe listings.\"\"\"\n\n    async with accept_cookies(context.page):\n        await context.page.wait_for_load_state('networkidle')\n        await context.infinite_scroll()\n        await context.enqueue_links(\n            selector='a.product-card__link-overlay', label='detail'\n        )\n"})}),"\n",(0,a.jsx)(t.h2,{id:"exporting-data-to-csv-format",children:"Exporting data to CSV format"}),"\n",(0,a.jsxs)(t.p,{children:["As we want to store all the shoe data into a CSV file, we can just add a call to the ",(0,a.jsx)(t.code,{children:"export_data"})," helper into the ",(0,a.jsx)(t.code,{children:"main.py"})," file just after the crawler run:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"    await crawler.export_data('shoes.csv')\n"})}),"\n",(0,a.jsx)(t.h2,{id:"working-crawler-and-its-code",children:"Working crawler and its code"}),"\n",(0,a.jsx)(t.p,{children:"Now, we have a crawler ready that can scrape all the shoes from the Nike website while handling infinite scrolling and many other problems, like the cookies dialog."}),"\n",(0,a.jsxs)(t.p,{children:["You can find the complete working crawler code here on the ",(0,a.jsx)(t.a,{href:"https://github.com/janbuchar/crawlee-python-demo",children:"GitHub repository"}),"."]}),"\n",(0,a.jsxs)(t.p,{children:["Learn more about Crawlee for Python from our latest step by step ",(0,a.jsx)(t.a,{href:"https://blog.apify.com/crawlee-for-python-tutorial/",children:"tutorial"}),"."]}),"\n",(0,a.jsxs)(t.p,{children:["If you have any doubts regarding this tutorial or using Crawlee for Python, feel free to ",(0,a.jsx)(t.a,{href:"https://apify.com/discord/",children:"join our discord community"})," and ask fellow developers or the Crawlee team."]})]})}function d(e={}){let{wrapper:t}={...(0,o.a)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},44953:function(e,t,n){n.d(t,{Z:function(){return i}});let i=n.p+"assets/images/infinite-scroll-de1fd1c1791fdf8f6b5614a947ccc878.webp"},67506:function(e,t,n){n.d(t,{Z:function(){return i}});let i=n.p+"assets/images/infinite-scroll-de1fd1c1791fdf8f6b5614a947ccc878.webp"},50065:function(e,t,n){n.d(t,{Z:function(){return l},a:function(){return r}});var i=n(67294);let a={},o=i.createContext(a);function r(e){let t=i.useContext(o);return i.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),i.createElement(o.Provider,{value:t},e.children)}},48064:function(e){e.exports=JSON.parse('{"permalink":"/blog/infinite-scroll-using-python","source":"@site/blog/2024/08-27-how-to-scrape-infinite-scrolling-pages/index.md","title":"How to scrape infinite scrolling webpages with Python","description":"Learn how to scrape infinite scrolling pages with Python and scrape Nike shoes using Crawlee for Python.","date":"2024-08-27T00:00:00.000Z","tags":[],"readingTime":6.61,"hasTruncateMarker":true,"authors":[{"name":"Saurav Jain","title":"Developer Community Manager","url":"https://github.com/souravjain540","socials":{"x":"https://x.com/sauain","github":"https://github.com/souravjain540"},"imageURL":"https://avatars.githubusercontent.com/u/53312820?v=4","key":"SauravJ","page":null}],"frontMatter":{"slug":"infinite-scroll-using-python","title":"How to scrape infinite scrolling webpages with Python","description":"Learn how to scrape infinite scrolling pages with Python and scrape Nike shoes using Crawlee for Python.","image":"./img/infinite-scroll.webp","authors":["SauravJ"]},"unlisted":false,"prevItem":{"title":"Web scraping of a dynamic website using Python with HTTP Client","permalink":"/blog/scraping-dynamic-websites-using-python"},"nextItem":{"title":"Current problems and mistakes of web scraping in Python and tricks to solve them!","permalink":"/blog/common-problems-in-web-scraping"}}')}}]);